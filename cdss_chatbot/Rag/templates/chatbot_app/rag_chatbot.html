<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG-Enhanced Clinical Decision Support System</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-dark {
            background: rgba(34, 197, 94, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .gradient-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .message-gradient {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .bot-message-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,253,244,0.95) 100%);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .floating-shapes::before,
        .floating-shapes::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        .floating-shapes::before {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            top: 10%;
            left: 10%;
            animation-delay: -2s;
        }
        
        .floating-shapes::after {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #86efac, #4ade80);
            bottom: 10%;
            right: 10%;
            animation-delay: -4s;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Legacy styles removed - using Tailwind classes */
    </style>
</head>
<body class="gradient-bg min-h-screen relative floating-shapes">
    <!-- Modern Header with Glassmorphism -->
    <header class="relative z-10">
        <div class="glass-dark backdrop-blur-md shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex items-center justify-center space-x-4">
                    <div class="p-3 bg-white/20 rounded-full">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
                        RAG-Enhanced CDSS
                    </h1>
                </div>
                <p class="text-center text-green-100 mt-2 text-lg font-medium">
                    Clinical Decision Support System
                </p>
            </div>
        </div>
    </header>
    
    <!-- Navigation with Glass Effect -->
    <nav class="relative z-10 py-4">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-center">
                <div class="glass rounded-full p-2 shadow-xl">
                    <div class="flex space-x-2">
                        <a href="/rag-chatbot/" class="px-6 py-3 rounded-full gradient-primary text-white font-semibold shadow-lg transform hover:scale-105 transition-all duration-300">
                            ü§ñ RAG Chatbot
                        </a>
                        <a href="/medical-search/" class="px-6 py-3 rounded-full bg-white/80 text-primary-700 font-semibold hover:bg-white transition-all duration-300 hover:shadow-lg">
                            üîç Medical Search
                        </a>
        </div>
    </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Container with Modern Layout -->
    <div class="max-w-7xl mx-auto px-4 py-8 relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Chat Section - Enhanced with Glassmorphism -->
            <div class="lg:col-span-2">
                <div class="gradient-card rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-all duration-500">
                    
                    <!-- Chat Header with Modern Design -->
                    <div class="gradient-primary p-6 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-white/20 rounded-full animate-pulse-slow">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">RAG Chatbot</h2>
                                <p class="text-green-100 text-sm">AI-Powered Clinical Assistant</p>
                            </div>
                        </div>
                        <button onclick="runFeatureTests()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-full text-white font-medium transition-all duration-300 transform hover:scale-105">
                    üß™ Test Features
                </button>
            </div>
                    
                    <!-- Chat Messages with Custom Styling -->
                    <div class="h-96 lg:h-[500px] overflow-y-auto p-6 space-y-4 scrollbar-hide bg-gradient-to-b from-white/50 to-primary-50/30" id="chat-messages">
                        <div class="flex justify-start animate-fade-in">
                            <div class="bot-message-gradient max-w-xs lg:max-w-md px-6 py-4 rounded-2xl rounded-bl-md shadow-lg">
                                <p class="text-gray-800 font-medium">Hello! I'm your RAG-enhanced Clinical Decision Support System. How can I help you today?</p>
                                <div class="text-xs text-gray-500 mt-2 text-right">Just now</div>
                </div>
            </div>
                    </div>
                    
                    <!-- Enhanced Chat Input -->
                    <div class="p-6 bg-white/60 backdrop-blur-sm border-t border-primary-200/30">
                        <div class="flex space-x-4">
                            <div class="flex-1 relative">
                                <input type="text" id="user-input" 
                                    class="w-full px-6 py-4 rounded-full border-2 border-primary-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-200 outline-none transition-all duration-300 bg-white/80 placeholder-gray-500 font-medium"
                                    placeholder="Type your medical query here..." 
                                    autocomplete="off">
                            </div>
                            <button id="send-button" 
                                class="w-14 h-14 gradient-primary rounded-full flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-300 group">
                                <svg class="w-6 h-6 text-white group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
                        </div>
                    </div>
            </div>
        </div>
        
            <!-- Analysis Section - Modern Design -->
            <div class="lg:col-span-1">
                <div class="gradient-card rounded-3xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-all duration-500">
                    
                    <!-- Analysis Header -->
                    <div class="gradient-primary p-6">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-white/20 rounded-full">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">Detailed Analysis</h2>
                                <p class="text-green-100 text-sm">AI Processing Results</p>
            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Content -->
                    <div class="h-96 lg:h-[600px] overflow-y-auto p-6 scrollbar-hide bg-gradient-to-b from-white/50 to-primary-50/30" id="analysis-content">
                        <div class="space-y-4">
                            <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 border border-primary-200/30 shadow-lg">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                                    <h3 class="text-lg font-bold text-primary-700">Welcome</h3>
                                </div>
                                <p class="text-gray-700">Detailed analysis of your query will appear here after you send a message.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const analysisContent = document.getElementById('analysis-content');
            
            // Function to add a message to the chat with modern styling
            function addMessage(message, isUser = false) {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('flex', isUser ? 'justify-end' : 'justify-start', 'animate-fade-in');
                
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('max-w-xs', 'lg:max-w-md', 'px-6', 'py-4', 'rounded-2xl', 'shadow-lg');
                
                if (isUser) {
                    messageDiv.classList.add('message-gradient', 'text-white', 'rounded-br-md');
                } else {
                    messageDiv.classList.add('bot-message-gradient', 'text-gray-800', 'rounded-bl-md');
                }
                
                // Format message text with line breaks
                const formattedMessage = message.replace(/\n/g, '<br>');
                const messageContent = document.createElement('p');
                messageContent.classList.add('font-medium');
                messageContent.innerHTML = formattedMessage;
                
                // Add timestamp
                const timeDiv = document.createElement('div');
                timeDiv.classList.add('text-xs', isUser ? 'text-green-100' : 'text-gray-500', 'mt-2', 'text-right');
                timeDiv.textContent = 'Just now';
                
                messageDiv.appendChild(messageContent);
                messageDiv.appendChild(timeDiv);
                messageContainer.appendChild(messageDiv);
                
                chatMessages.appendChild(messageContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Function to add a loading indicator with modern styling
            function addLoadingIndicator() {
                const loadingContainer = document.createElement('div');
                loadingContainer.classList.add('flex', 'justify-start', 'animate-fade-in', 'loading-message');
                
                const loadingDiv = document.createElement('div');
                loadingDiv.classList.add('bot-message-gradient', 'max-w-xs', 'lg:max-w-md', 'px-6', 'py-4', 'rounded-2xl', 'rounded-bl-md', 'shadow-lg');
                
                loadingDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-primary-500 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-primary-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-primary-300 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <span class="text-gray-600 font-medium">AI is thinking...</span>
                    </div>
                `;
                
                loadingContainer.appendChild(loadingDiv);
                chatMessages.appendChild(loadingContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return loadingContainer;
            }
            
            
            // Function to update the analysis section with modern cards
            function updateAnalysis(analysisData) {
                console.log('üîç Processing analysis data:', analysisData); // Debug log
                analysisContent.innerHTML = '<div class="space-y-6"></div>';
                const container = analysisContent.firstChild;
                
                // Add NLP Processing Pipeline Status directly to container
                if (analysisData.preprocessing_stats || analysisData.semantic_analysis || analysisData.llm_features) {
                const nlpStatusItem = document.createElement('div');
                    nlpStatusItem.classList.add('bg-gradient-to-r', 'from-primary-500', 'to-primary-600', 'rounded-2xl', 'p-6', 'shadow-xl', 'text-white', 'mb-6', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let nlpHtml = '<h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-3">üß†</span>NLP Processing Pipeline Status</h3>';
                
                // Preprocessing Status
                if (analysisData.preprocessing_stats) {
                        nlpHtml += '<div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 mb-4 border border-white/30">';
                        nlpHtml += '<h4 class="font-semibold mb-3 text-lg">üìù Text Preprocessing</h4>';
                        nlpHtml += '<div class="grid grid-cols-2 gap-3 text-sm">';
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Sentences: ${analysisData.preprocessing_stats.sentence_count || 0}</div>`;
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Tokens: ${analysisData.preprocessing_stats.token_count || 0}</div>`;
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Normalized: ${analysisData.preprocessing_stats.normalized_count || 0}</div>`;
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>POS tags: ${analysisData.preprocessing_stats.pos_count || 0}</div>`;
                    if (analysisData.preprocessing_stats.spell_corrections > 0) {
                            nlpHtml += `<div class="flex items-center col-span-2"><span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>Spell corrections: ${analysisData.preprocessing_stats.spell_corrections}</div>`;
                    }
                        nlpHtml += '</div></div>';
                }
                
                // Semantic Analysis Status
                if (analysisData.semantic_analysis) {
                        nlpHtml += '<div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 mb-4 border border-white/30">';
                        nlpHtml += '<h4 class="font-semibold mb-3 text-lg">üî¨ Semantic Analysis</h4>';
                    const entityCount = Object.keys(analysisData.semantic_analysis.medical_entities || {}).length;
                    const relationshipCount = (analysisData.semantic_analysis.medical_relationships || []).length;
                    const wsdCount = Object.keys(analysisData.semantic_analysis.word_sense_disambiguation || {}).length;
                    
                        nlpHtml += '<div class="grid grid-cols-2 gap-3 text-sm">';
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-2"></span>Entities: ${entityCount}</div>`;
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-2"></span>Relations: ${relationshipCount}</div>`;
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-2"></span>Disambiguated: ${wsdCount}</div>`;
                        nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 ${analysisData.semantic_analysis.error ? 'bg-red-300' : 'bg-green-300'} rounded-full mr-2"></span>UMLS: ${analysisData.semantic_analysis.error ? 'Error' : 'Active'}</div>`;
                        nlpHtml += '</div></div>';
                }
                
                // LLM Features Status
                if (analysisData.llm_features) {
                        nlpHtml += '<div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 border border-white/30">';
                        nlpHtml += '<h4 class="font-semibold mb-3 text-lg">ü§ñ Advanced LLM Features</h4>';
                        nlpHtml += '<div class="grid grid-cols-2 gap-3 text-sm">';
                    Object.entries(analysisData.llm_features).forEach(([feature, active]) => {
                            const statusColor = active ? 'bg-green-300' : 'bg-red-300';
                        const featureName = feature.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            nlpHtml += `<div class="flex items-center"><span class="w-2 h-2 ${statusColor} rounded-full mr-2"></span>${featureName}</div>`;
                    });
                        nlpHtml += '</div></div>';
                }
                
                nlpStatusItem.innerHTML = nlpHtml;
                    container.appendChild(nlpStatusItem);
                }
                
                // Add analysis overview with confidence and system info
                if (analysisData.summary || analysisData.confidence_score || analysisData.system_version) {
                    const summaryItem = document.createElement('div');
                    summaryItem.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'rounded-2xl', 'p-6', 'shadow-xl', 'text-white', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let summaryHtml = `
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-white/20 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">üìã Analysis Overview</h3>
                                <p class="text-blue-100 text-sm">Comprehensive Medical Assessment</p>
                            </div>
                        </div>
                    `;
                    
                    if (analysisData.confidence_score) {
                        const confidence = Math.round(analysisData.confidence_score * 100);
                        const confidenceColor = confidence >= 80 ? 'bg-green-400' : confidence >= 60 ? 'bg-yellow-400' : 'bg-red-400';
                        summaryHtml += `
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 mb-4 border border-white/20">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold">Analysis Confidence</h4>
                                    <span class="text-lg font-bold">${confidence}%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden">
                                    <div class="h-3 ${confidenceColor} rounded-full transition-all duration-1000 ease-out" 
                                         style="width: ${confidence}%"></div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (analysisData.summary) {
                        summaryHtml += `
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 mb-4 border border-white/20">
                                <h4 class="font-semibold mb-3">Clinical Summary</h4>
                                <div class="text-white/90 leading-relaxed text-sm whitespace-pre-wrap">${analysisData.summary}</div>
                            </div>
                        `;
                    }
                    
                    if (analysisData.system_version || analysisData.analysis_timestamp) {
                        summaryHtml += `
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                <div class="flex justify-between items-center text-xs text-blue-100">
                                    <div>${analysisData.system_version || 'Enhanced Medical AI v2.0'}</div>
                                    <div>${analysisData.analysis_timestamp ? new Date(analysisData.analysis_timestamp).toLocaleString() : 'Just now'}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    summaryItem.innerHTML = summaryHtml;
                    container.appendChild(summaryItem);
                }
                
                // Add differential diagnoses with comprehensive details
                if (analysisData.differential_diagnoses && analysisData.differential_diagnoses.length > 0) {
                    const diagnosesItem = document.createElement('div');
                    diagnosesItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let diagnosesHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üî¨ Differential Diagnoses</h3>
                        </div>
                    `;
                    
                    analysisData.differential_diagnoses.forEach((diagnosis, index) => {
                        const confidence = diagnosis.confidence || 0;
                        const urgencyScore = diagnosis.urgency_score || 0;
                        const urgencyColor = urgencyScore >= 8 ? 'bg-red-100 text-red-800' : urgencyScore >= 6 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                        
                        diagnosesHtml += `
                            <div class="mb-6 p-4 bg-white/40 rounded-xl border border-primary-100/50 backdrop-blur-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-center space-x-3">
                                        <strong class="text-gray-800 font-semibold">${diagnosis.condition}</strong>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${urgencyColor}">
                                            Urgency: ${urgencyScore}/10
                                        </span>
                                    </div>
                                    <span class="text-sm font-bold text-primary-600">${confidence}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
                                    <div class="h-3 bg-gradient-to-r from-primary-400 to-primary-600 rounded-full transition-all duration-1000 ease-out" 
                                         style="width: ${confidence}%; animation-delay: ${index * 0.2}s"></div>
                                </div>
                                ${diagnosis.description ? `<p class="text-gray-700 text-sm leading-relaxed mb-3">${diagnosis.description}</p>` : ''}
                                ${diagnosis.icd10_code ? `<div class="text-xs text-gray-600 mb-2"><strong>ICD-10:</strong> ${diagnosis.icd10_code}</div>` : ''}
                                ${diagnosis.prevalence ? `<div class="text-xs text-gray-600 mb-2"><strong>Prevalence:</strong> ${diagnosis.prevalence}</div>` : ''}
                                ${diagnosis.matched_symptoms && diagnosis.matched_symptoms.length > 0 ? `
                                    <div class="mt-3">
                                        <div class="text-xs font-semibold text-gray-700 mb-2">Matched Symptoms:</div>
                                        <div class="flex flex-wrap gap-1">
                                            ${diagnosis.matched_symptoms.map(symptom => 
                                                `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${symptom}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${diagnosis.complications && diagnosis.complications.length > 0 ? `
                                    <div class="mt-3">
                                        <div class="text-xs font-semibold text-gray-700 mb-2">Potential Complications:</div>
                                        <ul class="text-xs text-gray-600 space-y-1">
                                            ${diagnosis.complications.slice(0, 3).map(comp => `<li>‚Ä¢ ${comp}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    diagnosesItem.innerHTML = diagnosesHtml;
                    container.appendChild(diagnosesItem);
                }
                
                // Add recommendations with modern card styling
                if (analysisData.recommendations) {
                    const recommendationsItem = document.createElement('div');
                    recommendationsItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let recommendationsHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üíä Recommendations</h3>
                        </div>
                    `;
                    
                    // Immediate actions
                    if (analysisData.recommendations.immediate_actions && analysisData.recommendations.immediate_actions.length > 0) {
                        recommendationsHtml += `
                            <div class="mb-6 p-4 bg-red-50/80 rounded-xl border border-red-200/50">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-red-600">üö®</span>
                                    <div class="font-semibold text-red-700">Immediate Actions</div>
                                </div>
                                <ul class="space-y-2">
                                    ${analysisData.recommendations.immediate_actions.map(action => 
                                        `<li class="flex items-start space-x-2 text-sm text-red-800">
                                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${action}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Tests
                    if (analysisData.recommendations.tests && analysisData.recommendations.tests.length > 0) {
                        recommendationsHtml += `
                            <div class="mb-6 p-4 bg-blue-50/80 rounded-xl border border-blue-200/50">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-blue-600">üî¨</span>
                                    <div class="font-semibold text-blue-700">Recommended Tests</div>
                                </div>
                                <ul class="space-y-2">
                                    ${analysisData.recommendations.tests.map(test => 
                                        `<li class="flex items-start space-x-2 text-sm text-blue-800">
                                            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${test}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Lifestyle
                    if (analysisData.recommendations.lifestyle && analysisData.recommendations.lifestyle.length > 0) {
                        recommendationsHtml += `
                            <div class="mb-6 p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-green-600">üå±</span>
                                    <div class="font-semibold text-green-700">Lifestyle Recommendations</div>
                                </div>
                                <ul class="space-y-2">
                                    ${analysisData.recommendations.lifestyle.map(item => 
                                        `<li class="flex items-start space-x-2 text-sm text-green-800">
                                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${item}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Follow-up
                    if (analysisData.recommendations.follow_up) {
                        recommendationsHtml += `
                            <div class="p-4 bg-purple-50/80 rounded-xl border border-purple-200/50">
                                <div class="flex items-center space-x-2 mb-3">
                                    <span class="text-purple-600">üìÖ</span>
                                    <div class="font-semibold text-purple-700">Follow-up</div>
                                </div>
                                <p class="text-sm text-purple-800">${analysisData.recommendations.follow_up}</p>
                            </div>
                        `;
                    }
                    
                    recommendationsItem.innerHTML = recommendationsHtml;
                    container.appendChild(recommendationsItem);
                }
                
                // Add research papers with modern styling
                if (analysisData.research_papers && Object.keys(analysisData.research_papers).length > 0) {
                    const papersItem = document.createElement('div');
                    papersItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let papersHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üìö Relevant Research Papers</h3>
                        </div>
                    `;
                    
                    for (const [condition, papers] of Object.entries(analysisData.research_papers)) {
                        if (papers && papers.length > 0) {
                            papersHtml += `
                                <div class="mb-6">
                                    <h4 class="font-semibold text-primary-600 mb-4 flex items-center">
                                        <span class="w-2 h-2 bg-primary-500 rounded-full mr-2"></span>
                                        ${condition}
                                    </h4>
                                    <div class="space-y-4">
                            `;
                            
                            papers.forEach(paper => {
                                papersHtml += `
                                    <div class="p-4 bg-white/60 rounded-xl border border-primary-100/50 backdrop-blur-sm hover:shadow-lg transition-all duration-300">
                                        <h5 class="font-semibold text-gray-800 mb-2">${paper.title}</h5>
                                        <div class="text-sm text-gray-600 mb-2">
                                            <span class="font-medium">${paper.authors}</span> 
                                            <span class="text-gray-500">(${paper.year})</span> - 
                                            <span class="text-primary-600">${paper.journal}</span>
                                        </div>
                                        <p class="text-sm text-gray-700 mb-3 leading-relaxed">${paper.summary}</p>
                                    </div>
                                `;
                            });
                            
                            papersHtml += `</div></div>`;
                        }
                    }
                    
                    papersItem.innerHTML = papersHtml;
                    container.appendChild(papersItem);
                }
                
                // Add enhanced LLM response with modern styling
                if (analysisData.enhanced_response && analysisData.enhanced_response.response) {
                    const enhancedItem = document.createElement('div');
                    enhancedItem.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-indigo-600', 'rounded-2xl', 'p-6', 'shadow-xl', 'text-white', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    enhancedItem.innerHTML = `
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="p-2 bg-white/20 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">ü§ñ Enhanced Clinical Analysis</h3>
                                <p class="text-purple-100 text-sm">Response Type: ${analysisData.enhanced_response.response_type || 'general'}</p>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                            <div class="text-white leading-relaxed whitespace-pre-wrap">${analysisData.enhanced_response.response}</div>
                        </div>
                    `;
                    container.appendChild(enhancedItem);
                }
                
                // Add medical text summarization with modern styling
                if (analysisData.medical_summary) {
                    const summaryItem = document.createElement('div');
                    summaryItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let summaryHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üìù Medical Text Summarization</h3>
                        </div>
                    `;
                    
                    if (analysisData.medical_summary.extractive_summary) {
                        summaryHtml += `
                            <div class="mb-4 p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                                    <span class="text-green-600 mr-2">üîç</span>
                                    Extractive Summary
                                </h4>
                                <p class="text-green-800 text-sm leading-relaxed">${analysisData.medical_summary.extractive_summary}</p>
                            </div>
                        `;
                    }
                    
                    if (analysisData.medical_summary.abstractive_summary) {
                        summaryHtml += `
                            <div class="mb-4 p-4 bg-blue-50/80 rounded-xl border border-blue-200/50">
                                <h4 class="font-semibold text-blue-700 mb-3 flex items-center">
                                    <span class="text-blue-600 mr-2">üß†</span>
                                    Abstractive Summary
                                </h4>
                                <p class="text-blue-800 text-sm leading-relaxed">${analysisData.medical_summary.abstractive_summary}</p>
                            </div>
                        `;
                    }
                    
                    if (analysisData.medical_summary.key_findings && analysisData.medical_summary.key_findings.length > 0) {
                        summaryHtml += `
                            <div class="p-4 bg-purple-50/80 rounded-xl border border-purple-200/50">
                                <h4 class="font-semibold text-purple-700 mb-3 flex items-center">
                                    <span class="text-purple-600 mr-2">üí°</span>
                                    Key Findings
                                </h4>
                                <ul class="space-y-2">
                                    ${analysisData.medical_summary.key_findings.map(finding => 
                                        `<li class="flex items-start space-x-2 text-sm text-purple-800">
                                            <span class="w-1.5 h-1.5 bg-purple-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${finding}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    summaryItem.innerHTML = summaryHtml;
                    container.appendChild(summaryItem);
                }
                
                // Add semantic analysis results with modern styling
                if (analysisData.semantic_analysis && (
                    (analysisData.semantic_analysis.medical_entities && Object.keys(analysisData.semantic_analysis.medical_entities).length > 0) ||
                    (analysisData.semantic_analysis.word_sense_disambiguation && Object.keys(analysisData.semantic_analysis.word_sense_disambiguation).length > 0) ||
                    (analysisData.semantic_analysis.medical_relationships && analysisData.semantic_analysis.medical_relationships.length > 0)
                )) {
                    const semanticItem = document.createElement('div');
                    semanticItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let semanticHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üî¨ Semantic Analysis</h3>
                        </div>
                    `;
                    
                    // Medical entities
                    if (analysisData.semantic_analysis.medical_entities && Object.keys(analysisData.semantic_analysis.medical_entities).length > 0) {
                        semanticHtml += `
                            <div class="mb-4 p-4 bg-blue-50/80 rounded-xl border border-blue-200/50">
                                <h4 class="font-semibold text-blue-700 mb-3 flex items-center">
                                    <span class="text-blue-600 mr-2">üè∑Ô∏è</span>
                                    Medical Entities
                                </h4>
                                <div class="space-y-3">
                        `;
                        for (const [entityType, entities] of Object.entries(analysisData.semantic_analysis.medical_entities)) {
                            if (entities && entities.length > 0) {
                                semanticHtml += `
                                    <div>
                                        <strong class="text-blue-800 text-sm">${entityType}:</strong>
                                        <div class="mt-2 flex flex-wrap gap-2">
                                `;
                                semanticHtml += entities.map(entity => 
                                    `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">${entity.text}</span>`
                                ).join('');
                                semanticHtml += '</div></div>';
                            }
                        }
                        semanticHtml += '</div></div>';
                    }
                    
                    // Word sense disambiguation
                    if (analysisData.semantic_analysis.word_sense_disambiguation && Object.keys(analysisData.semantic_analysis.word_sense_disambiguation).length > 0) {
                        semanticHtml += `
                            <div class="mb-4 p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                                    <span class="text-green-600 mr-2">üéØ</span>
                                    Word Sense Disambiguation
                                </h4>
                                <div class="space-y-2">
                        `;
                        for (const [word, sense] of Object.entries(analysisData.semantic_analysis.word_sense_disambiguation)) {
                            semanticHtml += `
                                <div class="flex items-center space-x-2 text-sm">
                                    <span class="font-medium text-green-800">${word}</span>
                                    <span class="text-green-600">‚Üí</span>
                                    <span class="text-green-700">${sense.medical_sense || word}</span>
                                </div>
                            `;
                        }
                        semanticHtml += '</div></div>';
                    }
                    
                    // Medical relationships
                    if (analysisData.semantic_analysis.medical_relationships && analysisData.semantic_analysis.medical_relationships.length > 0) {
                        semanticHtml += `
                            <div class="p-4 bg-purple-50/80 rounded-xl border border-purple-200/50">
                                <h4 class="font-semibold text-purple-700 mb-3 flex items-center">
                                    <span class="text-purple-600 mr-2">üîó</span>
                                    Medical Relationships
                                </h4>
                                <div class="space-y-2">
                        `;
                        analysisData.semantic_analysis.medical_relationships.forEach(rel => {
                            semanticHtml += `
                                <div class="text-sm text-purple-800">
                                    <span class="font-medium">${rel.subject}</span>
                                    <span class="mx-2 px-2 py-1 bg-purple-100 rounded font-medium">${rel.relation}</span>
                                    <span class="font-medium">${rel.object}</span>
                                </div>
                            `;
                        });
                        semanticHtml += '</div></div>';
                    }
                    
                    semanticItem.innerHTML = semanticHtml;
                    container.appendChild(semanticItem);
                }
                
                // Add Q&A results with modern styling
                if (analysisData.qa_results && analysisData.qa_results.length > 0) {
                    const qaItem = document.createElement('div');
                    qaItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let qaHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">‚ùì Question & Answer Results</h3>
                        </div>
                        <div class="space-y-4">
                    `;
                    
                    analysisData.qa_results.forEach((qa, index) => {
                        qaHtml += `
                            <div class="p-4 bg-yellow-50/80 rounded-xl border border-yellow-200/50">
                                <div class="font-semibold text-yellow-800 mb-2">${qa.answer}</div>
                                <div class="text-sm text-yellow-700">
                                    Confidence: <span class="font-medium">${qa.confidence}</span> 
                                    (Score: <span class="font-medium">${qa.score.toFixed(3)}</span>)
                                </div>
                            </div>
                        `;
                    });
                    
                    qaHtml += '</div>';
                    qaItem.innerHTML = qaHtml;
                    container.appendChild(qaItem);
                }
                
                // Add LLM features indicator with modern styling
                if (analysisData.llm_features && Object.keys(analysisData.llm_features).length > 0) {
                    const featuresItem = document.createElement('div');
                    featuresItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let featuresHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üöÄ Active LLM Features</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                    `;
                    
                    const featureNames = {
                        'dense_retrieval': 'üîç Dense Retrieval',
                        'text_summarization': 'üìù Text Summarization', 
                        'question_answering': '‚ùì Question Answering',
                        'enhanced_rag': 'ü§ñ Enhanced RAG'
                    };
                    
                    for (const [feature, active] of Object.entries(analysisData.llm_features)) {
                        const statusColor = active ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
                        const statusIcon = active ? '‚úÖ' : '‚ùå';
                        const name = featureNames[feature] || feature.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        featuresHtml += `
                            <div class="p-3 rounded-xl border ${statusColor} text-center text-sm font-medium">
                                <div>${statusIcon}</div>
                                <div class="mt-1">${name}</div>
                            </div>
                        `;
                    }
                    
                    featuresHtml += '</div>';
                    featuresItem.innerHTML = featuresHtml;
                    container.appendChild(featuresItem);
                }
                
                // Add treatment recommendations
                if (analysisData.treatment_recommendations && analysisData.treatment_recommendations.length > 0) {
                    const treatmentItem = document.createElement('div');
                    treatmentItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let treatmentHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üíä Treatment Recommendations</h3>
                        </div>
                        <div class="space-y-4">
                    `;
                    
                    analysisData.treatment_recommendations.forEach((treatment, index) => {
                        const urgencyColor = treatment.urgency >= 8 ? 'bg-red-50 border-red-200' : treatment.urgency >= 6 ? 'bg-yellow-50 border-yellow-200' : 'bg-green-50 border-green-200';
                        treatmentHtml += `
                            <div class="p-4 ${urgencyColor} rounded-xl border backdrop-blur-sm">
                                <div class="flex justify-between items-start mb-2">
                                    <strong class="text-gray-800 font-semibold">${treatment.treatment}</strong>
                                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${treatment.evidence_level || 'Standard'}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    <strong>Condition:</strong> ${treatment.condition}
                                </div>
                                <div class="text-xs text-gray-500">
                                    <strong>Source:</strong> ${treatment.source || 'Clinical Guidelines'}
                                </div>
                            </div>
                        `;
                    });
                    
                    treatmentHtml += '</div>';
                    treatmentItem.innerHTML = treatmentHtml;
                    container.appendChild(treatmentItem);
                }

                // Add clinical recommendations
                if (analysisData.clinical_recommendations) {
                    const clinicalItem = document.createElement('div');
                    clinicalItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let clinicalHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üè• Clinical Recommendations</h3>
                        </div>
                    `;
                    
                    if (analysisData.clinical_recommendations.immediate_actions && analysisData.clinical_recommendations.immediate_actions.length > 0) {
                        clinicalHtml += `
                            <div class="mb-4 p-4 bg-red-50/80 rounded-xl border border-red-200/50">
                                <h4 class="font-semibold text-red-700 mb-3 flex items-center">
                                    <span class="text-red-600 mr-2">üö®</span>Immediate Actions
                                </h4>
                                <ul class="space-y-2">
                                    ${analysisData.clinical_recommendations.immediate_actions.map(action => 
                                        `<li class="flex items-start space-x-2 text-sm text-red-800">
                                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${action}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.clinical_recommendations.diagnostic_tests && analysisData.clinical_recommendations.diagnostic_tests.length > 0) {
                        clinicalHtml += `
                            <div class="mb-4 p-4 bg-blue-50/80 rounded-xl border border-blue-200/50">
                                <h4 class="font-semibold text-blue-700 mb-3 flex items-center">
                                    <span class="text-blue-600 mr-2">üî¨</span>Diagnostic Tests
                                </h4>
                                <ul class="space-y-2">
                                    ${analysisData.clinical_recommendations.diagnostic_tests.map(test => 
                                        `<li class="flex items-start space-x-2 text-sm text-blue-800">
                                            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${test}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.clinical_recommendations.specialist_referrals && analysisData.clinical_recommendations.specialist_referrals.length > 0) {
                        clinicalHtml += `
                            <div class="mb-4 p-4 bg-purple-50/80 rounded-xl border border-purple-200/50">
                                <h4 class="font-semibold text-purple-700 mb-3 flex items-center">
                                    <span class="text-purple-600 mr-2">üë®‚Äç‚öïÔ∏è</span>Specialist Referrals
                                </h4>
                                <div class="flex flex-wrap gap-2">
                                    ${analysisData.clinical_recommendations.specialist_referrals.map(specialist => 
                                        `<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">${specialist}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    clinicalItem.innerHTML = clinicalHtml;
                    container.appendChild(clinicalItem);
                }

                // Add diagnostic workup
                if (analysisData.diagnostic_workup) {
                    const diagnosticItem = document.createElement('div');
                    diagnosticItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let diagnosticHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üî¨ Diagnostic Workup</h3>
                        </div>
                    `;
                    
                    if (analysisData.diagnostic_workup.immediate_tests && analysisData.diagnostic_workup.immediate_tests.length > 0) {
                        diagnosticHtml += `
                            <div class="mb-4 p-4 bg-red-50/80 rounded-xl border border-red-200/50">
                                <h4 class="font-semibold text-red-700 mb-3">üö® Immediate Tests</h4>
                                <ul class="space-y-1">
                                    ${analysisData.diagnostic_workup.immediate_tests.map(test => 
                                        `<li class="text-sm text-red-800">‚Ä¢ ${test}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.diagnostic_workup.routine_tests && analysisData.diagnostic_workup.routine_tests.length > 0) {
                        diagnosticHtml += `
                            <div class="mb-4 p-4 bg-blue-50/80 rounded-xl border border-blue-200/50">
                                <h4 class="font-semibold text-blue-700 mb-3">üìã Routine Tests</h4>
                                <ul class="space-y-1">
                                    ${analysisData.diagnostic_workup.routine_tests.map(test => 
                                        `<li class="text-sm text-blue-800">‚Ä¢ ${test}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.diagnostic_workup.imaging_studies && analysisData.diagnostic_workup.imaging_studies.length > 0) {
                        diagnosticHtml += `
                            <div class="mb-4 p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <h4 class="font-semibold text-green-700 mb-3">üì∑ Imaging Studies</h4>
                                <ul class="space-y-1">
                                    ${analysisData.diagnostic_workup.imaging_studies.map(study => 
                                        `<li class="text-sm text-green-800">‚Ä¢ ${study}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    diagnosticItem.innerHTML = diagnosticHtml;
                    container.appendChild(diagnosticItem);
                }

                // Add patient education
                if (analysisData.patient_education) {
                    const educationItem = document.createElement('div');
                    educationItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let educationHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üìö Patient Education</h3>
                        </div>
                    `;
                    
                    if (analysisData.patient_education.lifestyle_guidance && analysisData.patient_education.lifestyle_guidance.length > 0) {
                        educationHtml += `
                            <div class="mb-4 p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                                    <span class="text-green-600 mr-2">üå±</span>Lifestyle Guidance
                                </h4>
                                <ul class="space-y-2">
                                    ${analysisData.patient_education.lifestyle_guidance.slice(0, 5).map(item => 
                                        `<li class="flex items-start space-x-2 text-sm text-green-800">
                                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${item}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.patient_education.warning_signs && analysisData.patient_education.warning_signs.length > 0) {
                        educationHtml += `
                            <div class="mb-4 p-4 bg-red-50/80 rounded-xl border border-red-200/50">
                                <h4 class="font-semibold text-red-700 mb-3 flex items-center">
                                    <span class="text-red-600 mr-2">‚ö†Ô∏è</span>Warning Signs
                                </h4>
                                ${analysisData.patient_education.warning_signs.map(warning => `
                                    <div class="mb-3">
                                        <div class="font-medium text-red-800 mb-1">${warning.condition}</div>
                                        <div class="text-sm text-red-700">${warning.when_to_seek_help}</div>
                                        ${warning.emergency_signs && warning.emergency_signs.length > 0 ? `
                                            <ul class="mt-2 space-y-1">
                                                ${warning.emergency_signs.map(sign => 
                                                    `<li class="text-xs text-red-600">‚Ä¢ ${sign}</li>`
                                                ).join('')}
                                            </ul>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    educationItem.innerHTML = educationHtml;
                    container.appendChild(educationItem);
                }

                // Add follow-up plan
                if (analysisData.follow_up_plan) {
                    const followUpItem = document.createElement('div');
                    followUpItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let followUpHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üìÖ Follow-up Plan</h3>
                        </div>
                    `;
                    
                    if (analysisData.follow_up_plan.immediate_follow_up && analysisData.follow_up_plan.immediate_follow_up.length > 0) {
                        followUpHtml += `
                            <div class="mb-4 p-4 bg-red-50/80 rounded-xl border border-red-200/50">
                                <h4 class="font-semibold text-red-700 mb-3">üö® Immediate (0-48 hours)</h4>
                                <ul class="space-y-1">
                                    ${analysisData.follow_up_plan.immediate_follow_up.map(item => 
                                        `<li class="text-sm text-red-800">‚Ä¢ ${item}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.follow_up_plan.short_term_follow_up && analysisData.follow_up_plan.short_term_follow_up.length > 0) {
                        followUpHtml += `
                            <div class="mb-4 p-4 bg-yellow-50/80 rounded-xl border border-yellow-200/50">
                                <h4 class="font-semibold text-yellow-700 mb-3">üìã Short-term (1-4 weeks)</h4>
                                <ul class="space-y-1">
                                    ${analysisData.follow_up_plan.short_term_follow_up.map(item => 
                                        `<li class="text-sm text-yellow-800">‚Ä¢ ${item}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.follow_up_plan.long_term_follow_up && analysisData.follow_up_plan.long_term_follow_up.length > 0) {
                        followUpHtml += `
                            <div class="mb-4 p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <h4 class="font-semibold text-green-700 mb-3">üóìÔ∏è Long-term (1-12 months)</h4>
                                <ul class="space-y-1">
                                    ${analysisData.follow_up_plan.long_term_follow_up.map(item => 
                                        `<li class="text-sm text-green-800">‚Ä¢ ${item}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    followUpItem.innerHTML = followUpHtml;
                    container.appendChild(followUpItem);
                }

                // Add emergency protocols
                if (analysisData.emergency_protocols) {
                    const emergencyItem = document.createElement('div');
                    emergencyItem.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'rounded-2xl', 'p-6', 'shadow-xl', 'text-white', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let emergencyHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="p-2 bg-white/20 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">üö® Emergency Protocols</h3>
                                <p class="text-red-100 text-sm">Critical care guidelines</p>
                            </div>
                        </div>
                    `;
                    
                    if (analysisData.emergency_protocols.immediate_actions && analysisData.emergency_protocols.immediate_actions.length > 0) {
                        emergencyHtml += `
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 mb-4 border border-white/20">
                                <h4 class="font-semibold mb-3">Immediate Actions</h4>
                                <ul class="space-y-2">
                                    ${analysisData.emergency_protocols.immediate_actions.map(action => 
                                        `<li class="flex items-start space-x-2 text-sm">
                                            <span class="w-1.5 h-1.5 bg-white rounded-full mt-2 flex-shrink-0"></span>
                                            <span>${action}</span>
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    if (analysisData.emergency_protocols.emergency_contacts && analysisData.emergency_protocols.emergency_contacts.length > 0) {
                        emergencyHtml += `
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                <h4 class="font-semibold mb-3">Emergency Contacts</h4>
                                <ul class="space-y-1">
                                    ${analysisData.emergency_protocols.emergency_contacts.map(contact => 
                                        `<li class="text-sm">‚Ä¢ ${contact}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    emergencyItem.innerHTML = emergencyHtml;
                    container.appendChild(emergencyItem);
                }

                // Add medication information
                if (analysisData.medication_information) {
                    const medicationItem = document.createElement('div');
                    medicationItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let medicationHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üíä Medication Information</h3>
                        </div>
                    `;
                    
                    if (analysisData.medication_information.recommended_medications && analysisData.medication_information.recommended_medications.length > 0) {
                        medicationHtml += `
                            <div class="mb-4 p-4 bg-blue-50/80 rounded-xl border border-blue-200/50">
                                <h4 class="font-semibold text-blue-700 mb-3">üíä Recommended Medications</h4>
                                <div class="space-y-3">
                                    ${analysisData.medication_information.recommended_medications.map(med => `
                                        <div class="p-3 bg-white/60 rounded-lg border border-blue-100">
                                            <div class="font-medium text-blue-800">${med.medication}</div>
                                            <div class="text-sm text-blue-600 mt-1">For: ${med.condition}</div>
                                            <div class="text-xs text-blue-500 mt-1">Evidence: ${med.evidence_level || 'Standard'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (analysisData.medication_information.drug_interactions && analysisData.medication_information.drug_interactions.length > 0) {
                        medicationHtml += `
                            <div class="mb-4 p-4 bg-yellow-50/80 rounded-xl border border-yellow-200/50">
                                <h4 class="font-semibold text-yellow-700 mb-3">‚ö†Ô∏è Drug Interactions</h4>
                                <div class="space-y-2">
                                    ${analysisData.medication_information.drug_interactions.map(interaction => `
                                        <div class="text-sm">
                                            <span class="font-medium text-yellow-800">${interaction.medication}</span>: 
                                            <span class="text-yellow-700">${interaction.interaction}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (analysisData.medication_information.dosage_guidelines && analysisData.medication_information.dosage_guidelines.length > 0) {
                        medicationHtml += `
                            <div class="p-4 bg-green-50/80 rounded-xl border border-green-200/50">
                                <h4 class="font-semibold text-green-700 mb-3">üìã Dosage Guidelines</h4>
                                <ul class="space-y-1">
                                    ${analysisData.medication_information.dosage_guidelines.slice(0, 4).map(guideline => 
                                        `<li class="text-sm text-green-800">‚Ä¢ ${guideline}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    medicationItem.innerHTML = medicationHtml;
                    container.appendChild(medicationItem);
                }

                // Add retrieved context with modern styling
                if (analysisData.retrieved_context && analysisData.retrieved_context.length > 0) {
                    const contextItem = document.createElement('div');
                    contextItem.classList.add('bg-white/60', 'backdrop-blur-sm', 'rounded-2xl', 'p-6', 'border', 'border-primary-200/30', 'shadow-lg', 'transform', 'hover:scale-105', 'transition-all', 'duration-300');
                    
                    let contextHtml = `
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-3 h-3 bg-primary-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-primary-700">üìö Relevant Medical Knowledge</h3>
                        </div>
                        <div class="space-y-3">
                    `;
                    
                    analysisData.retrieved_context.forEach((context, index) => {
                        contextHtml += `
                            <div class="p-4 bg-white/40 rounded-xl border border-primary-100/50 backdrop-blur-sm hover:shadow-md transition-all duration-300">
                                <div class="flex items-start space-x-3">
                                    <span class="w-6 h-6 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0 mt-0.5">${index + 1}</span>
                                    <p class="text-gray-700 text-sm leading-relaxed">${context}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    contextHtml += '</div>';
                    contextItem.innerHTML = contextHtml;
                    container.appendChild(contextItem);
                }
            }
            
            // Function to send a message to the API
            async function sendMessage(message) {
                // Add user message to chat
                addMessage(message, true);
                
                // Add loading indicator
                const loadingIndicator = addLoadingIndicator();
                
                try {
                    const response = await fetch('/api/rag-chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message }),
                    });
                    
                    // Remove loading indicator
                    loadingIndicator.remove();
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Add bot response to chat
                        addMessage(data.message);
                        
                        // Update analysis section
                        if (data.full_analysis) {
                            updateAnalysis(data.full_analysis);
                        }
                    } else {
                        const errorData = await response.json();
                        addMessage(`Error: ${errorData.error || 'Something went wrong'}`);
                    }
                } catch (error) {
                    // Remove loading indicator
                    loadingIndicator.remove();
                    
                    // Add detailed error message
                    console.error('Network error:', error);
                    let errorMessage = 'Connection failed. ';
                    
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage += 'Please check if the Django server is running on http://127.0.0.1:8000/';
                    } else {
                        errorMessage += error.message || 'Something went wrong';
                    }
                    
                    addMessage(`‚ùå Error: ${errorMessage}`);
                }
            }
            
            // Event listener for send button
            sendButton.addEventListener('click', function() {
                const message = userInput.value.trim();
                if (message) {
                    sendMessage(message);
                    userInput.value = '';
                }
            });
            
            // Event listener for Enter key
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const message = userInput.value.trim();
                    if (message) {
                        sendMessage(message);
                        userInput.value = '';
                    }
                }
            });
            
            // Feature testing function
            async function runFeatureTests() {
                console.log('üß™ Starting comprehensive feature tests...');
                
                // Show a test message in chat
                addMessage('üß™ Running comprehensive NLP and LLM feature tests...', 'bot');
                
                try {
                    const response = await fetch('/api/test-all-features/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('üéØ Test Results:', data);
                    
                    if (data.status === 'success') {
                        const results = data.test_results;
                        
                        // Create detailed test results message
                        let resultMessage = '‚úÖ Feature Test Results:\n\n';
                        
                        // Summary
                        resultMessage += `üìä Summary: ${results.summary.tests_passed}/${results.summary.total_tests} tests passed (${results.summary.success_rate})\n\n`;
                        
                        // Individual test results
                        for (const [testName, testResult] of Object.entries(results.tests)) {
                            const status = testResult.status === 'PASSED' ? '‚úÖ' : '‚ùå';
                            const name = testName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            resultMessage += `${status} ${name}: ${testResult.status}\n`;
                            
                            if (testResult.status === 'FAILED' && testResult.error) {
                                resultMessage += `   Error: ${testResult.error}\n`;
                            }
                        }
                        
                        // Add detailed analysis to the analysis panel
                        const analysisData = {
                            summary: 'Comprehensive Feature Test Results',
                            test_results: results,
                            preprocessing_stats: {
                                sentence_count: 1,
                                token_count: 5,
                                normalized_count: 4,
                                pos_count: 5,
                                spell_corrections: 2
                            },
                            semantic_analysis: {
                                medical_entities: { 'test': [{'text': 'chest pain'}] },
                                medical_relationships: [],
                                word_sense_disambiguation: {}
                            },
                            llm_features: {
                                dense_retrieval: true,
                                text_summarization: true,
                                question_answering: true,
                                enhanced_rag: true
                            }
                        };
                        
                        updateAnalysis(analysisData);
                        addMessage(resultMessage, 'bot');
                        
                    } else {
                        addMessage('‚ùå Feature tests failed: ' + (data.error || 'Unknown error'), 'bot');
                    }
                    
                } catch (error) {
                    console.error('Test execution error:', error);
                    addMessage('‚ùå Error running feature tests: ' + error.message, 'bot');
                }
            }
            
            // Make runFeatureTests globally available
            window.runFeatureTests = runFeatureTests;
        });
    </script>
</body>
</html> 